-webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath d='M78.6 5C69.1-2.4 55.6-1.5 47 7L7 47c-8.5 8.5-9.4 22-2.1 31.6l80 104c4.5 5.9 11.6 9.4 19 9.4h54.1l109 109c-14.7 29-10 65.4 14.3 89.6l112 112c12.5 12.5 32.8 12.5 45.3 0l64-64c12.5-12.5 12.5-32.8 0-45.3l-112-112c-24.2-24.2-60.6-29-89.6-14.3l-109-109V104c0-7.5-3.5-14.5-9.4-19L78.6 5zM19.9 396.1C7.2 408.8 0 426.1 0 444.1C0 481.6 30.4 512 67.9 512c18 0 35.3-7.2 48-19.9L233.7 374.3c-7.8-20.9-9-43.6-3.6-65.1l-61.7-61.7L19.9 396.1zM512 144c0-10.5-1.3-20.7-3.7-30.5c-2.4-9.8-16.5-14.3-23.4-7.3L448 144l-96 96 32 32 96-96 37.8-37.8c7-7 2.5-21-7.3-23.4c-9.8-2.4-20-3.7-30.5-3.7z'/%3E%3C/svg%3E");
}

.settings-icon {
  mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath d='M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z'/%3E%3C/svg%3E");
  -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath d='M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2onMounted(() => {
  // Fetch printer data and initialize
  addConsoleMessage('Printer management interface loaded')
})

// Watch for hotend temperature changes for the filament wizard
watch(() => printer.value.currentTemps.hotend, (newTemp) => {
  if (showFilamentWizard.value && wizardStep.value === 1 && newTemp >= filamentChangeTemp.value) {
    wizardStep.value = 2
    addConsoleMessage('Hotend temperature reached, ready to remove filament')
  }
})
</script>

<style scoped>
.management-wrapper {
  min-height: 100vh;
  width: 100%;
  display: flex;
  background-color: #f5f7fb;
}

.management-container {
  width: 100%;
  display: flex;
  background-color: #1a1a1a;
  color: #e0e0e0;
}

.sidebar {
  width: 240px;
  background-color: #1a1a1a;
  padding: 20px 0;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  height: 100vh;
  position: fixed;
  left: 0;
  top: 0;
  border-right: 1px solid #333;
}

.logo-container {
  padding: 0 20px;
  margin-bottom: 40px;
}

.company-logo {
  width: 100%;
  max-width: 180px;
  height: auto;
}

.nav-links {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
}

.nav-item {
  display: flex;
  align-items: center;
  padding: 12px 24px;
  color: #a0a0a0;
  text-decoration: none;
  transition: all 0.3s ease;
  margin-bottom: 5px;
}

.nav-item.active,
.nav-item:hover {
  background-color: #2d2d2d;
  color: #1e88e5;
}

.nav-icon {
  margin-right: 12px;
  width: 20px;
  height: 20px;
  background-color: currentColor;
  mask-size: contain;
  mask-repeat: no-repeat;
  mask-position: center;
  -webkit-mask-size: contain;
  -webkit-mask-repeat: no-repeat;
  -webkit-mask-position: center;
}

.home-icon {
  mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 576 512'%3E%3Cpath d='M575.8 255.5c0 18-15 32.1-32 32.1h-32l.7 160.2c0 2.7-.2 5.4-.5 8.1V472c0 22.1-17.9 40-40 40H456c-1.1 0-2.2 0-3.3-.1c-1.4 .1-2.8 .1-4.2 .1H416 392c-22.1 0-40-17.9-40-40V448 384c0-17.7-14.3-32-32-32H256c-17.7 0-32 14.3-32 32v64 24c0 22.1-17.9 40-40 40H160 128.1c-1.5 0-3-.1-4.5-.2c-1.2 .1-2.4 .2-3.6 .2H104c-22.1 0-40-17.9-40-40V360c0-.9 0-1.9 .1-2.8V287.6H32c-18 0-32-14-32-32.1c0-9 3-17 10-24L266.4 8c7-7 15-8 22-8s15 2 21 7L564.8 231.5c8 7 12 15 11 24z'/%3E%3C/svg%3E");
  -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 576 512'%3E%3Cpath d='M575.8 255.5c0 18-15 32.1-32 32.1h-32l.7 160.2c0 2.7-.2 5.4-.5 8.1V472c0 22.1-17.9 40-40 40H456c-1.1 0-2.2 0-3.3-.1c-1.4 .1-2.8 .1-4.2 .1H416 392c-22.1 0-40-17.9-40-40V448 384c0-17.7-14.3-32-32-32H256c-17.7 0-32 14.3-32 32v64 24c0 22.1-17.9 40-40 40H160 128.1c-1.5 0-3-.1-4.5-.2c-1.2 .1-2.4 .2-3.6 .2H104c-22.1 0-40-17.9-40-40V360c0-.9 0-1.9 .1-2.8V287.6H32c-18 0-32-14-32-32.1c0-9 3-17 10-24L266.4 8c7-7 15-8 22-8s15 2 21 7L564.8 231.5c8 7 12 15 11 24z'/%3E%3C/svg%3E");
}

.printer-icon {
  mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath d='M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zM432 248a24 24 0 1 1 0 48 24 24 0 1 1 0-48z'/%3E%3C/svg%3E");
  -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath d='M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zM432 248a24 24 0 1 1 0 48 24 24 0 1 1 0-48z'/%3E%3C/svg%3E");
}

.filament-icon {
  mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath d='M234.5 5.7c13.9-5 29.1-5 43.1 0l192 68.6C495 83.4 512 107.5 512 134.6V377.4c0 27-17 51.2-42.5 60.3l-192 68.6c-13.9 5-29.1 5-43.1 0l-192-68.6C17 428.6 0 404.5 0 377.4V134.6c0-27 17-51.2 42.5-60.3l192-68.6zM256 66L82.3 128 256 190l173.7-62L256 66zm32 368.6l160-57.1v-188L288 246.6v188z'/%3E%3C/svg%3E");
  -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath d='M234.5 5.7c13.9-5 29.1-5 43.1 0l192 68.6C495 83.4 512 107.5 512 134.6V377.4c0 27-17 51.2-42.5 60.3l-192 68.6c-13.9 5-29.1 5-43.1 0l-192-68.6C17 428.6 0 404.5 0 377.4V134.6c0-27 17-51.2 42.5-60.3l192-68.6zM256 66L82.3 128 256 190l173.7-62L256 66zm32 368.6l160-57.1v-188L288 246.6v188z'/%3E%3C/svg%3E");
}

.maintenance-icon {
  mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath d='M78.6 5C69.1-2.4 55.6-1.5 47 7L7 47c-8.5 8.5-9.4 22-2.1 31.6l80 104c4.5 5.9 11.6 9.4 19 9.4h54.1l109 109c-14.7 29-10 65.4 14.3 89.6l112 112c12.5 12.5 32.8 12.5 45.3 0l64-64c12.5-12.5 12.5-32.8 0-45.3l-112-112c-24.2-24.2-60.6-29-89.6-14.3l-109-109V104c0-7.5-3.5-14.5-9.4-19L78.6 5zM19.9 396.1C7.2 408.8 0 426.1 0 444.1C0 481.6 30.4 512 67.9 512c18 0 35.3-7.2 48-19.9L233.7 374.3c-7.8-20.9-9-43.6-3.6-65.1l-61.7-61.7L19.9 396.1zM512 144c0-10.5-1.3-20.7-3.7-30.5c-2.4-9.8-16.5-14.3-23.4-7.3L448 144l-96 96 32 32 96-96 37.8-37.8c7-7 2.5-21-7.3-23.4c-9.8-2.4-20-3.7-30.5-3.7z'/%3E%3C/svg%3E");
  -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath d='M78.6 5C69.1-2.4 55.6-1.5 47 7L7 47c-8.5 8.5-9.4 22-2.1 31.6l80 104c4.5 5.9 11.6 9.4 19 9.4h54.1l109 109c-14.7 29-10 65.4 14.3 89.6l112 112c12.5 12.5 32.8 12.5 45.3 0l64-64c12.5-12.5 12.5-32.8 0-45.3l-112-112c-24.2-24.2-60.6-29-89.6-14.3l-109-109V104c0-7.5-3.5-14.5-9.4-19L78.6 5zM19.9 396.1C7.2 408.8 0 426.1 0 444.1C0 481.6 30.4 512 67.9 512c18 0 35.3-7.2 48-19.9L233.7 374.3c-7.8-20.9-9-43.6-3.6<template>
  <div class="management-wrapper">
    <div class="management-container">
      <div class="sidebar">
        <div class="logo-container">
          <img src="/logo.png" alt="Company Logo" class="company-logo" />
        </div>
        <div class="nav-links">
          <router-link to="/dashboard" class="nav-item">
            <i class="nav-icon home-icon"></i>
            <span>Dashboard</span>
          </router-link>
          <router-link to="/printers" class="nav-item active">
            <i class="nav-icon printer-icon"></i>
            <span>Printers</span>
          </router-link>
          <router-link to="/filaments" class="nav-item">
            <i class="nav-icon filament-icon"></i>
            <span>Filaments</span>
          </router-link>
          <router-link to="/maintenance" class="nav-item">
            <i class="nav-icon maintenance-icon"></i>
            <span>Maintenance</span>
          </router-link>
          <router-link to="/settings" class="nav-item">
            <i class="nav-icon settings-icon"></i>
            <span>Settings</span>
          </router-link>
        </div>
        <div class="logout-container">
          <button @click="handleLogout" class="logout-button">SIGN OUT</button>
        </div>
      </div>
      
      <div class="main-content">
        <div class="header">
          <div class="header-left">
            <button @click="goBack" class="back-button">
              <i class="back-icon"></i> Back
            </button>
            <h1>Manage Printer: {{ printer.name }}</h1>
          </div>
          <div class="printer-status" :class="printer.status">
            <span class="status-indicator"></span>
            <span class="status-text">{{ printer.status }}</span>
          </div>
        </div>
        
        <div class="management-grid">
          <!-- Printer Control Panel -->
          <div class="card control-card">
            <h3>Control Panel</h3>
            <div class="control-panel">
              <div class="temperature-controls">
                <h4>Temperature Controls</h4>
                <div class="control-group">
                  <div class="control-row">
                    <label>Hotend</label>
                    <input type="number" v-model="hotendTemp" min="0" max="300" />
                    <button @click="setHotendTemp" class="temp-btn" :disabled="!isConnected">Set</button>
                  </div>
                  <div class="temp-display">
                    <span class="current-temp">Current: {{ printer.currentTemps.hotend }}°C</span>
                    <span class="target-temp">Target: {{ printer.targetTemps.hotend }}°C</span>
                  </div>
                </div>
                <div class="control-group">
                  <div class="control-row">
                    <label>Bed</label>
                    <input type="number" v-model="bedTemp" min="0" max="120" />
                    <button @click="setBedTemp" class="temp-btn" :disabled="!isConnected">Set</button>
                  </div>
                  <div class="temp-display">
                    <span class="current-temp">Current: {{ printer.currentTemps.bed }}°C</span>
                    <span class="target-temp">Target: {{ printer.targetTemps.bed }}°C</span>
                  </div>
                </div>
                <div class="control-actions">
                  <button @click="coolDown" class="cool-btn" :disabled="!isConnected">Cool Down</button>
                  <button @click="preheat" class="preheat-btn" :disabled="!isConnected">Preheat PLA</button>
                </div>
              </div>
              
              <div class="motion-controls">
                <h4>Motion Controls</h4>
                <div class="axis-controls">
                  <div class="axis-label">X/Y Axis</div>
                  <div class="axis-buttons">
                    <button class="move-btn blank"></button>
                    <button @click="moveAxis('Y', 10)" class="move-btn" :disabled="!isConnected">
                      <i class="arrow-icon up"></i>
                    </button>
                    <button class="move-btn blank"></button>
                    
                    <button @click="moveAxis('X', -10)" class="move-btn" :disabled="!isConnected">
                      <i class="arrow-icon left"></i>
                    </button>
                    <button @click="homeAxes" class="move-btn home" :disabled="!isConnected">
                      <i class="home-icon"></i>
                    </button>
                    <button @click="moveAxis('X', 10)" class="move-btn" :disabled="!isConnected">
                      <i class="arrow-icon right"></i>
                    </button>
                    
                    <button class="move-btn blank"></button>
                    <button @click="moveAxis('Y', -10)" class="move-btn" :disabled="!isConnected">
                      <i class="arrow-icon down"></i>
                    </button>
                    <button class="move-btn blank"></button>
                  </div>
                  
                  <div class="z-controls">
                    <div class="axis-label">Z Axis</div>
                    <div class="z-buttons">
                      <button @click="moveAxis('Z', 10)" class="move-btn" :disabled="!isConnected">
                        <i class="arrow-icon up"></i>
                      </button>
                      <button @click="moveAxis('Z', -10)" class="move-btn" :disabled="!isConnected">
                        <i class="arrow-icon down"></i>
                      </button>
                    </div>
                  </div>
                  
                  <div class="distance-selector">
                    <span>Movement Distance:</span>
                    <div class="distance-buttons">
                      <button 
                        v-for="dist in [0.1, 1, 10, 100]" 
                        :key="dist"
                        @click="movementDistance = dist" 
                        :class="['distance-btn', { active: movementDistance === dist }]"
                        :disabled="!isConnected"
                      >
                        {{ dist }}mm
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="extrusion-controls">
                <h4>Extrusion</h4>
                <div class="extrusion-actions">
                  <button @click="extrude(10)" class="extrude-btn" :disabled="!isConnected || !isHotendReady">
                    Extrude 10mm
                  </button>
                  <button @click="extrude(-10)" class="extrude-btn" :disabled="!isConnected || !isHotendReady">
                    Retract 10mm
                  </button>
                </div>
                <div class="warning-message" v-if="!isHotendReady && isConnected">
                  Hotend must be at least 170°C for extrusion
                </div>
              </div>
            </div>
          </div>
          
          <!-- Print Job Control -->
          <div class="card job-card">
            <h3>Print Job Control</h3>
            <div class="job-status-panel">
              <div class="status-section">
                <h4>Current Job</h4>
                <div v-if="activeJob" class="active-job">
                  <div class="job-info">
                    <span class="job-name">{{ activeJob.name }}</span>
                    <span class="job-start">Started: {{ formatDateTime(activeJob.startTime) }}</span>
                    <span class="job-estimate">Est. Time Remaining: {{ formatDuration(activeJob.estimatedTimeRemaining) }}</span>
                  </div>
                  <div class="job-progress">
                    <div class="progress-info">
                      <span>Progress: {{ activeJob.progress }}%</span>
                      <span>Layer: {{ activeJob.currentLayer }}/{{ activeJob.totalLayers }}</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-value" :style="{ width: activeJob.progress + '%' }"></div>
                    </div>
                  </div>
                  <div class="job-actions">
                    <button @click="pauseJob" class="job-btn pause" v-if="!activeJob.paused">Pause</button>
                    <button @click="resumeJob" class="job-btn resume" v-else>Resume</button>
                    <button @click="cancelJob" class="job-btn cancel">Cancel</button>
                  </div>
                </div>
                <div v-else class="no-job">
                  <p>No active print job</p>
                </div>
              </div>
              
              <div class="upload-section">
                <h4>Upload New File</h4>
                <div class="file-upload">
                  <label for="file-input" class="file-label">
                    <span v-if="!selectedFile">Choose File</span>
                    <span v-else>{{ selectedFile.name }}</span>
                  </label>
                  <input id="file-input" type="file" accept=".gcode,.stl" @change="handleFileSelect" class="file-input" />
                  <button @click="uploadFile" class="upload-btn" :disabled="!selectedFile || !isConnected">Upload</button>
                </div>
              </div>
              
              <div class="file-list-section">
                <h4>Stored Files</h4>
                <div class="file-list">
                  <div v-for="(file, index) in storedFiles" :key="index" class="file-item">
                    <span class="file-name">{{ file.name }}</span>
                    <div class="file-actions">
                      <button @click="printFile(file)" class="file-btn print" :disabled="!isConnected">Print</button>
                      <button @click="deleteFile(file)" class="file-btn delete">Delete</button>
                    </div>
                  </div>
                  <div v-if="storedFiles.length === 0" class="no-files">
                    <p>No stored files</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Connection Status -->
          <div class="card connection-card">
            <h3>Connection Status</h3>
            <div class="connection-panel">
              <div class="connection-status">
                <div class="status-indicator" :class="{ connected: isConnected }"></div>
                <div class="status-info">
                  <span class="status-text">{{ isConnected ? 'Connected' : 'Disconnected' }}</span>
                  <span v-if="isConnected" class="connection-details">{{ printer.connectionDetails }}</span>
                </div>
              </div>
              <div class="connection-actions">
                <button v-if="!isConnected" @click="connectPrinter" class="connection-btn connect">Connect</button>
                <button v-else @click="disconnectPrinter" class="connection-btn disconnect">Disconnect</button>
                <button @click="refreshConnection" class="connection-btn refresh" :disabled="!isConnected">Refresh</button>
              </div>
            </div>
            
            <div class="console-section">
              <h4>Printer Console</h4>
              <div class="console-output" ref="consoleOutput">
                <div v-for="(line, index) in consoleLines" :key="index" class="console-line">
                  {{ line }}
                </div>
              </div>
              <div class="console-input">
                <input 
                  type="text" 
                  v-model="gcodeCommand" 
                  @keyup.enter="sendCommand"
                  placeholder="Enter G-code command"
                  :disabled="!isConnected"
                />
                <button @click="sendCommand" class="send-btn" :disabled="!isConnected">Send</button>
              </div>
            </div>
          </div>
          
          <!-- Filament Management -->
          <div class="card filament-card">
            <h3>Filament Management</h3>
            <div class="filament-panel">
              <div class="current-filaments">
                <h4>Loaded Filaments</h4>
                <div class="filament-list">
                  <div v-for="(filament, index) in printer.filaments" :key="index" class="filament-item">
                    <div class="filament-color" :style="{ backgroundColor: getColorCode(filament.color) }"></div>
                    <div class="filament-info">
                      <span class="filament-name">{{ filament.color }}</span>
                      <div class="progress-bar">
                        <div 
                          class="progress-value" 
                          :style="{ width: filament.level + '%', backgroundColor: getColorCode(filament.color) }"
                        ></div>
                      </div>
                      <span class="filament-percentage">{{ filament.level }}%</span>
                    </div>
                    <button @click="changeFilament(filament)" class="filament-btn change" :disabled="!isConnected">
                      Change
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="filament-change-wizard" v-if="showFilamentWizard">
                <h4>Filament Change Wizard</h4>
                <div class="wizard-steps">
                  <div class="wizard-step" :class="{ active: wizardStep === 1 }">
                    <div class="step-number">1</div>
                    <div class="step-content">
                      <h5>Heat Nozzle</h5>
                      <p>Heating nozzle to {{ filamentChangeTemp }}°C</p>
                      <div v-if="wizardStep === 1" class="step-progress">
                        <div class="progress-bar">
                          <div 
                            class="progress-value" 
                            :style="{ width: (printer.currentTemps.hotend / filamentChangeTemp * 100) + '%' }"
                          ></div>
                        </div>
                        <span class="temp-display">{{ printer.currentTemps.hotend }}°C / {{ filamentChangeTemp }}°C</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="wizard-step" :class="{ active: wizardStep === 2 }">
                    <div class="step-number">2</div>
                    <div class="step-content">
                      <h5>Remove Filament</h5>
                      <p>Press the button to retract filament</p>
                      <button 
                        v-if="wizardStep === 2" 
                        @click="retractFilament" 
                        class="wizard-btn"
                      >
                        Retract Filament
                      </button>
                    </div>
                  </div>
                  
                  <div class="wizard-step" :class="{ active: wizardStep === 3 }">
                    <div class="step-number">3</div>
                    <div class="step-content">
                      <h5>Load New Filament</h5>
                      <p>Insert new filament and press the button to load</p>
                      <div v-if="wizardStep === 3" class="new-filament-selector">
                        <select v-model="newFilamentColor">
                          <option value="black">Black</option>
                          <option value="white">White</option>
                          <option value="cyan">Cyan</option>
                          <option value="magenta">Magenta</option>
                          <option value="yellow">Yellow</option>
                          <option value="red">Red</option>
                          <option value="green">Green</option>
                          <option value="blue">Blue</option>
                        </select>
                        <button @click="loadFilament" class="wizard-btn">Load Filament</button>
                      </div>
                    </div>
                  </div>
                  
                  <div class="wizard-step" :class="{ active: wizardStep === 4 }">
                    <div class="step-number">4</div>
                    <div class="step-content">
                      <h5>Purge Filament</h5>
                      <p>Purge the filament until color is clean</p>
                      <div v-if="wizardStep === 4" class="purge-controls">
                        <button @click="purgeFilament(5)" class="wizard-btn">Purge 5mm</button>
                        <button @click="purgeFilament(10)" class="wizard-btn">Purge 10mm</button>
                        <button @click="wizardStep = 5" class="wizard-btn next">Next</button>
                      </div>
                    </div>
                  </div>
                  
                  <div class="wizard-step" :class="{ active: wizardStep === 5 }">
                    <div class="step-number">5</div>
                    <div class="step-content">
                      <h5>Finish</h5>
                      <p>Filament change complete</p>
                      <button v-if="wizardStep === 5" @click="finishFilamentChange" class="wizard-btn complete">
                        Finish
                      </button>
                    </div>
                  </div>
                </div>
                
                <button @click="cancelFilamentChange" class="cancel-wizard-btn">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, nextTick, watch } from 'vue'
import { useRouter, useRoute } from 'vue-router'

const router = useRouter()
const route = useRoute()
const printerId = route.params.id

// Form inputs and state
const hotendTemp = ref(200)
const bedTemp = ref(60)
const movementDistance = ref(10)
const selectedFile = ref(null)
const gcodeCommand = ref('')
const consoleLines = ref([
  '> Printer initialized',
  '> Firmware: v3.10.0',
  '> Ready for commands'
])
const consoleOutput = ref(null)
const isConnected = ref(true)
const showFilamentWizard = ref(false)
const wizardStep = ref(1)
const filamentChangeTemp = ref(200)
const newFilamentColor = ref('black')

// Sample printer data
const printer = ref({
  id: 1,
  name: 'Prusa i3 MK3S+',
  status: 'online',
  connectionDetails: 'USB (COM3) at 115200 baud',
  currentTemps: {
    hotend: 25,
    bed: 24
  },
  targetTemps: {
    hotend: 0,
    bed: 0
  },
  filaments: [
    { color: 'black', level: 89 },
    { color: 'cyan', level: 89 },
    { color: 'magenta', level: 86 },
    { color: 'yellow', level: 86 }
  ]
})

// Sample active job
const activeJob = ref(null)
// Sample: 
// {
//   name: 'Smartphone Stand',
//   startTime: new Date(),
//   estimatedTimeRemaining: 3600 * 1.5,
//   progress: 45,
//   currentLayer: 23,
//   totalLayers: 50,
//   paused: false
// }

// Sample stored files
const storedFiles = ref([
  { name: 'smartphone_stand.gcode', size: 4500000, uploaded: new Date(2025, 4, 1) },
  { name: 'desk_organizer.gcode', size: 8900000, uploaded: new Date(2025, 3, 25) },
  { name: 'calibration_cube.gcode', size: 1200000, uploaded: new Date(2025, 3, 20) }
])

// Computed properties
const isHotendReady = computed(() => {
  return printer.value.currentTemps.hotend >= 170
})

// Methods
const goBack = () => {
  router.push(`/printers/${printerId}`)
}

// Temperature control
const setHotendTemp = () => {
  printer.value.targetTemps.hotend = hotendTemp.value
  addConsoleMessage(`Setting hotend temperature to ${hotendTemp.value}°C`)
  // Simulate temperature change
  simulateTemperatureChange('hotend')
}

const setBedTemp = () => {
  printer.value.targetTemps.bed = bedTemp.value
  addConsoleMessage(`Setting bed temperature to ${bedTemp.value}°C`)
  // Simulate temperature change
  simulateTemperatureChange('bed')
}

const coolDown = () => {
  printer.value.targetTemps.hotend = 0
  printer.value.targetTemps.bed = 0
  addConsoleMessage('Cooling down all heaters')
  // Simulate temperature change
  simulateTemperatureChange('hotend')
  simulateTemperatureChange('bed')
}

const preheat = () => {
  hotendTemp.value = 200
  bedTemp.value = 60
  setHotendTemp()
  setBedTemp()
  addConsoleMessage('Preheating for PLA')
}

// Motion control
const moveAxis = (axis, distance) => {
  const actualDistance = distance * (movementDistance.value / 10)
  addConsoleMessage(`Moving ${axis} axis by ${actualDistance}mm`)
}

const homeAxes = () => {
  addConsoleMessage('Homing all axes')
}

// Extrusion control
const extrude = (amount) => {
  addConsoleMessage(`Extruding ${amount}mm of filament`)
}

// Job control
const pauseJob = () => {
  if (activeJob.value) {
    activeJob.value.paused = true
    addConsoleMessage('Print job paused')
  }
}

const resumeJob = () => {
  if (activeJob.value) {
    activeJob.value.paused = false
    addConsoleMessage('Print job resumed')
  }
}

const cancelJob = () => {
  if (confirm('Are you sure you want to cancel the current print job?')) {
    addConsoleMessage('Print job cancelled')
    activeJob.value = null
  }
}

// File handling
const handleFileSelect = (event) => {
  selectedFile.value = event.target.files[0]
}

const uploadFile = () => {
  if (selectedFile.value) {
    addConsoleMessage(`Uploading file: ${selectedFile.value.name}`)
    
    // Simulate file upload
    setTimeout(() => {
      storedFiles.value.unshift({
        name: selectedFile.value.name,
        size: selectedFile.value.size,
        uploaded: new Date()
      })
      
      addConsoleMessage(`File ${selectedFile.value.name} uploaded successfully`)
      selectedFile.value = null
    }, 1500)
  }
}

const printFile = (file) => {
  addConsoleMessage(`Starting print job: ${file.name}`)
  
  // Simulate starting a print job
  activeJob.value = {
    name: file.name,
    startTime: new Date(),
    estimatedTimeRemaining: 3600 * 2,
    progress: 0,
    currentLayer: 1,
    totalLayers: 50,
    paused: false
  }
  
  // Simulate print progress
  simulatePrintProgress()
}

const deleteFile = (file) => {
  if (confirm(`Are you sure you want to delete ${file.name}?`)) {
    const index = storedFiles.value.findIndex(f => f.name === file.name)
    if (index !== -1) {
      storedFiles.value.splice(index, 1)
      addConsoleMessage(`File ${file.name} deleted`)
    }
  }
}

// Connection management
const connectPrinter = () => {
  addConsoleMessage('Connecting to printer...')
  
  // Simulate connection
  setTimeout(() => {
    isConnected.value = true
    printer.value.status = 'online'
    addConsoleMessage('Connected successfully')
    addConsoleMessage('> Printer initialized')
    addConsoleMessage('> Firmware: v3.10.0')
    addConsoleMessage('> Ready for commands')
  }, 1500)
}

const disconnectPrinter = () => {
  addConsoleMessage('Disconnecting from printer...')
  
  // Simulate disconnection
  setTimeout(() => {
    isConnected.value = false
    printer.value.status = 'offline'
    addConsoleMessage('Disconnected from printer')
  }, 500)
}

const refreshConnection = () => {
  addConsoleMessage('Refreshing connection...')
  
  // Simulate refresh
  setTimeout(() => {
    addConsoleMessage('Connection refreshed')
  }, 1000)
}

// Console management
const sendCommand = () => {
  if (gcodeCommand.value) {
    addConsoleMessage(`> ${gcodeCommand.value}`)
    
    // Process command (simplified for demo)
    if (gcodeCommand.value.toUpperCase().startsWith('G28')) {
      addConsoleMessage('Homing all axes')
    } else if (gcodeCommand.value.toUpperCase().startsWith('M104')) {
      addConsoleMessage('Setting hotend temperature')
    } else if (gcodeCommand.value.toUpperCase().startsWith('M140')) {
      addConsoleMessage('Setting bed temperature')
    } else {
      addConsoleMessage('ok')
    }
    
    gcodeCommand.value = ''
  }
}

const addConsoleMessage = (message) => {
  consoleLines.value.push(message)
  
  // Keep only the last 50 messages
  if (consoleLines.value.length > 50) {
    consoleLines.value = consoleLines.value.slice(-50)
  }
  
  // Scroll to bottom of console
  nextTick(() => {
    if (consoleOutput.value) {
      consoleOutput.value.scrollTop = consoleOutput.value.scrollHeight
    }
  })
}

// Filament change
const changeFilament = (filament) => {
  showFilamentWizard.value = true
  wizardStep.value = 1
  addConsoleMessage(`Starting filament change wizard for ${filament.color} filament`)
  
  // Start heating
  printer.value.targetTemps.hotend = filamentChangeTemp.value
  simulateTemperatureChange('hotend', () => {
    if (printer.value.currentTemps.hotend >= filamentChangeTemp.value) {
      wizardStep.value = 2
    }
  })
}

const retractFilament = () => {
  addConsoleMessage('Retracting filament')
  
  // Simulate retraction
  setTimeout(() => {
    addConsoleMessage('Filament retracted')
    wizardStep.value = 3
  }, 2000)
}

const loadFilament = () => {
  addConsoleMessage(`Loading ${newFilamentColor.value} filament`)
  
  // Simulate loading
  setTimeout(() => {
    addConsoleMessage('Filament loaded')
    wizardStep.value = 4
  }, 2000)
}

const purgeFilament = (amount) => {
  addConsoleMessage(`Purging ${amount}mm of filament`)
  
  // Simulate purging
  setTimeout(() => {
    addConsoleMessage('Filament purged')
  }, 1000)
}

const finishFilamentChange = () => {
  // Update the filament in the printer
  const filamentIndex = printer.value.filaments.findIndex(f => f.color === printer.value.filaments[0].color)
  if (filamentIndex !== -1) {
    printer.value.filaments[filamentIndex].color = newFilamentColor.value
    printer.value.filaments[filamentIndex].level = 100
  }
  
  addConsoleMessage('Filament change completed')
  coolDown()
  showFilamentWizard.value = false
  wizardStep.value = 1
}

const cancelFilamentChange = () => {
  if (confirm('Are you sure you want to cancel the filament change?')) {
    addConsoleMessage('Filament change cancelled')
    coolDown()
    showFilamentWizard.value = false
    wizardStep.value = 1
  }
}

// Format functions
const formatDateTime = (date) => {
  const options = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }
  return new Date(date).toLocaleDateString('en-US', options)
}

const formatDuration = (seconds) => {
  const hours = Math.floor(seconds / 3600)
  const minutes = Math.floor((seconds % 3600) / 60)
  
  if (hours === 0) {
    return `${minutes}m`
  }
  
  return `${hours}h ${minutes}m`
}

// Simulation functions
const simulateTemperatureChange = (heater, callback) => {
  const target = printer.value.targetTemps[heater]
  const current = printer.value.currentTemps[heater]
  
  if (target === current) return
  
  const interval = setInterval(() => {
    if (target > current) {
      printer.value.currentTemps[heater] += 1
    } else {
      printer.value.currentTemps[heater] -= 1
    }
    
    if (printer.value.currentTemps[heater] === target) {
      clearInterval(interval)
      if (callback) callback()
    }
  }, 100)
}

const simulatePrintProgress = () => {
  if (!activeJob.value) return
  
  const interval = setInterval(() => {
    if (!activeJob.value) {
      clearInterval(interval)
      return
    }
    
    if (activeJob.value.paused) return
    
    activeJob.value.progress += 1
    activeJob.value.estimatedTimeRemaining -= 72 // 2 hours / 100 = 72 seconds per percent
    
    if (activeJob.value.progress % 2 === 0) {
      activeJob.value.currentLayer += 1
    }
    
    if (activeJob.value.progress >= 100) {
      activeJob.value.progress = 100
      activeJob.value.currentLayer = activeJob.value.totalLayers
      activeJob.value.estimatedTimeRemaining = 0
      addConsoleMessage('Print job completed successfully')
      setTimeout(() => {
        activeJob.value = null
        clearInterval(interval)
      }, 3000)
    }
  }, 1000)
}

// Get color code from color name
const getColorCode = (color) => {
  const colorMap = {
    black: '#000000',
    cyan: '#00BFFF',
    magenta: '#FF00FF',
    yellow: '#FFFF00',
    white: '#FFFFFF',
    red: '#FF0000',
    green: '#00FF00',
    blue: '#0000FF'
  }
  
  return colorMap[color.toLowerCase()] || '#777777'
}

// Handle logout
const handleLogout = () => {
  // Add your logout logic here
  router.push('/login')
}

// Lifecycle hooks
onMounted(() => {
  // Fetch printer data and initialize
  addConsoleMessage('Printer management interface loaded')
})

// Watch for hotend temperature changes for the filament wizard
watch(() => printer.value.currentTemps.hotend, (newTemp) => {
  if (showFilamentWizard.value && wizardStep.value === 1 && newTemp >= filamentChangeTemp.value) {
    wizardStep.value = 2
    addConsoleMessage('Hotend temperature reached, ready to remove filament')
  }
})